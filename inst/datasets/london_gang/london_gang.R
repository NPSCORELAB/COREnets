
library(igraph)
library(tidyverse)
library(COREnets)

# paper: https://journals.sagepub.com/doi/figure/10.1177/1477370812447738?

# read in file extensions ======================================================
files <- list.files(path="inst/datasets/london_gang/",
                    pattern = "\\.csv$", 
                    full.names = TRUE
                    )

# read adjacency matrix ========================================================
edges <- files %>%
  purrr::discard(stringr::str_detect,
                 pattern = "_ATTR.csv") %>%
  read_csv() %>%
  COREnets::to_matrix() %>%
  igraph::graph_from_adjacency_matrix(weighted = TRUE,
                                      mode = "undirected") %>%
  get.data.frame("edges") %>%
  # The extracted weights represent edge types
  mutate(type      = weight,
         edge_type = case_when(type == 1 ~ "Hang Out Together",
                               type == 2 ~ "Co-Offend Together",
                               type == 3 ~ "Co-Offend Together, Serious Crime",
                               type == 4 ~ "Co-Offend Together, Seriour Crime, Kin"),
         from_class = "people",
         to_class   = "people"
         ) %>%
  select(from, to, from_class, to_class, type, edge_type)

# read attribute table =========================================================
nodes <- files %>%
  purrr::keep(stringr::str_detect,
              pattern = "_ATTR.csv") %>%
  read_csv() %>%
  as_tibble() %>%
  rename(name = X1) %>%
  mutate(node_class    = "people",
         # Recode attributes for human readability -----------------------------
         hr_birthplace = case_when(Birthplace == 1 ~ "West Africa",
                                   Birthplace == 2 ~ "Caribbean",
                                   Birthplace == 3 ~ "United Kingdom",
                                   Birthplace == 4 ~ "East Africa")
         )

# Note 17 June 2019 ============================================================
# Though the dataset was downloaded from UCINet's site there are issues with the
# reliability of variables. For instance, the original paper cited by the site
# makes no mention of some of the variables (e.g., music) and perhaps more 
# alarmingly the birthplace variables have been reorganized and no longer match
# those used in the paper. To air on the side of caution, we have recoded the 
# variables to match those reported in the UCINet site.

# build igraph object ==========================================================
g <- igraph::graph_from_data_frame(
  d        = edges,
  directed = FALSE,
  vertices = nodes
)

# build final dataset ==========================================================
.introduction <- "This dataset is on co-offending individuals in a London-based
inner-city street gang from 2005 to 2009. Data comes from anonymized police
arrests and convition data for confirmed members of the gang."

.abstract <- "Despite acknowledgment of ‘hybrid’ street gangs in the literature,
there is little systematic research into ethnic heterogeneity within gangs.
This dataset was generated by researchers aiming at moving beyond the broad
categorization of the Black street gang. For this purpose, they examine an
all-Black Londonbased gang in detail, using fieldwork and police arrest data, 
and investigate the role of ethnic heterogeneity for the workings of the gang.
Findings suggest that ethnic heterogeneity within this gang is crucial for its 
criminal operation. Although there is no evidence for ethnicity-related 
specialization of crime, the structural co-offending pattern of the gang’s
activities is dominated by ethnicity."

.bibtex <- c(
  "@Article{londongang_2012,
  title   = {Ethnic Heterogeneity in the Activity and Structure of a Black Street Gang.}, 
  volume  = {9},
  issue   = {3},
  journal = {European Journal of Criminology.}, 
  author  = {Grund, T. and Densley, J.}, 
  year    = {2012},
  pages   = {388-406},
  }"
)

.codebook <- data.frame(
  `Edge Type` = c("1",
                  "2",
                  "3",
                  "4"),
  data_type   = c("one-mode",
                  "one-mode",
                  "one-mode",
                  "one-mode"),
  definition  = c("Undirected valued relationship for actors who hang out together.",
                  "Undirected valued relationship for actors who co-offend together.",
                  "Undirected valued relationship for actors who co-offend together and committed a serious crime.",
                  "Undirected valued relationship for actors who co-offend together, committed a serious crime, and are kin."),
  stringsAsFactors = FALSE
)

.metadata <- list(
  title        = "London Gang",
  name         = "london_gang",
  tags         = c("street gangs",
                   "crime",
                   "homophily",
                   "heterogeneity",
                   "ethnicity"),
  introduction = .introduction,
  abstract     = .abstract,
  codebook     = .codebook,
  bibtex       = .bibtex,
  paper_link   = "https://journals.sagepub.com/doi/figure/10.1177/1477370812447738?")

.network <- list(
  net_metadata = unnest_edge_types(g, "edge_type") %>%
    purrr::map(~.x %>%
                 generate_graph_metadata),
  nodes_table = igraph::as_data_frame(g, what = "vertices"),
  edges_table = igraph::as_data_frame(g, what = "edges")
)

london_gang <- list(
  metadata = .metadata,
  network  = .network
)

london_gang

#test
